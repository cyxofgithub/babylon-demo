<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html,
            body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="canvasZone"><canvas id="renderCanvas"></canvas></div>
        <script>
            const canvas = document.getElementById("renderCanvas");

            const startRenderLoop = function (engine, canvas) {
                engine.runRenderLoop(function () {
                    if (sceneToRender && sceneToRender.activeCamera) {
                        sceneToRender.render();
                    }
                });
            };

            var sceneToRender = null;
            const createDefaultEngine = function () {
                return new BABYLON.Engine(canvas, true, {
                    preserveDrawingBuffer: true,
                    stencil: true,
                    disableWebGL2Support: false,
                });
            };
            const createScene = () => {
                const scene = new BABYLON.Scene(engine);
                // 创建一个动作管理器
                scene.actionManager = new BABYLON.ActionManager(scene);

                scene.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        {
                            trigger: BABYLON.ActionManager.OnKeyUpTrigger,
                            parameter: function (actionEvent) {
                                return actionEvent.sourceEvent.key === "R";
                            },
                        },
                        function () {
                            console.log("R button was pressed");
                        }
                    )
                );

                /**** Set camera and light *****/
                const camera = new BABYLON.ArcRotateCamera(
                    "camera",
                    -Math.PI / 2,
                    Math.PI / 2.5,
                    10,
                    new BABYLON.Vector3(0, 0, 0)
                );

                // 限制相机在垂直方向上的旋转角度范围
                camera.lowerBetaLimit = 0.1; // 最小角度
                camera.upperBetaLimit = Math.PI / 2; // 最大角度

                camera.attachControl(canvas, true);
                const light = new BABYLON.HemisphericLight(
                    "light",
                    new BABYLON.Vector3(1, 1, 0)
                );

                const boxMat = new BABYLON.StandardMaterial("boxMat");
                boxMat.diffuseTexture = new BABYLON.Texture(
                    "https://www.babylonjs-playground.com/textures/floor.png"
                );

                /**** World Objects *****/
                const box = BABYLON.MeshBuilder.CreateBox("box", {});
                box.material = boxMat;
                box.position.y = 0.5;

                // 创建一个指针拖动行为
                const dragBehavior = new BABYLON.PointerDragBehavior({
                    dragPlaneNormal: new BABYLON.Vector3(0, 1, 0),
                });
                dragBehavior.useObjectOrientationForDragging = false;
                box.addBehavior(dragBehavior);

                // 创建X轴模型
                const xAxis = BABYLON.MeshBuilder.CreateLines(
                    "xAxis",
                    {
                        points: [
                            BABYLON.Vector3.Zero(),
                            new BABYLON.Vector3(1, 0, 0),
                        ],
                    },
                    scene
                );
                xAxis.color = new BABYLON.Color3(1, 0, 0);
                xAxis.isVisible = false;

                // 创建Y轴模型
                const yAxis = BABYLON.MeshBuilder.CreateLines(
                    "yAxis",
                    {
                        points: [
                            BABYLON.Vector3.Zero(),
                            new BABYLON.Vector3(0, 1, 0),
                        ],
                    },
                    scene
                );
                yAxis.color = new BABYLON.Color3(0, 1, 0);
                yAxis.isVisible = false;

                // 创建Z轴模型
                const zAxis = BABYLON.MeshBuilder.CreateLines(
                    "zAxis",
                    {
                        points: [
                            BABYLON.Vector3.Zero(),
                            new BABYLON.Vector3(0, 0, 1),
                        ],
                    },
                    scene
                );
                zAxis.color = new BABYLON.Color3(0, 0, 1);
                zAxis.isVisible = false;

                // 注册一个点击网格时触发的动作
                box.actionManager = new BABYLON.ActionManager(scene);
                box.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnPickTrigger,
                        function (evt) {
                            if (evt.meshUnderPointer) {
                                // 获取点击的网格
                                var mesh = evt.meshUnderPointer;

                                // 设置轴模型的父网格
                                xAxis.parent = mesh;
                                yAxis.parent = mesh;
                                zAxis.parent = mesh;

                                // 设置轴模型的位置为网格的位置
                                xAxis.position.copyFrom(mesh.position);
                                yAxis.position.copyFrom(mesh.position);
                                zAxis.position.copyFrom(mesh.position);

                                // 显示轴模型
                                xAxis.isVisible = true;
                                yAxis.isVisible = true;
                                zAxis.isVisible = true;

                                // 启用拖动行为
                                dragBehavior.attach(box);
                            }
                        }
                    )
                );

                // 注册一个在每帧渲染之前触发的动作
                box.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnEveryFrameTrigger,
                        function () {
                            if (dragBehavior.dragging) {
                                // 更新轴模型的位置为拖动行为的位置
                                xAxis.position.copyFrom(
                                    dragBehavior.lastDragPosition
                                );
                                yAxis.position.copyFrom(
                                    dragBehavior.lastDragPosition
                                );
                                zAxis.position.copyFrom(
                                    dragBehavior.lastDragPosition
                                );
                            }
                        }
                    )
                );

                // 注册一个在松开鼠标按钮时触发的动作
                box.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnPickUpTrigger,
                        function () {
                            // 隐藏轴模型
                            xAxis.isVisible = false;
                            yAxis.isVisible = false;
                            zAxis.isVisible = false;
                        }
                    )
                );

                const boxWidth = 10;
                const boxHeight = 0.5;
                const boxDepth = 10;

                const ground = BABYLON.MeshBuilder.CreateBox(
                    "box",
                    { width: boxWidth, height: boxHeight, depth: boxDepth },
                    scene
                );

                const wallThickness = boxHeight;
                const wallHeight = boxDepth / 2;
                const wallDepth = boxDepth;

                const wall1 = BABYLON.MeshBuilder.CreateBox(
                    "wall1",
                    {
                        width: wallThickness,
                        height: wallHeight,
                        depth: wallDepth,
                    },
                    scene
                );
                wall1.position = new BABYLON.Vector3(
                    ground.position.x - boxWidth / 2 - wallThickness / 2,
                    2.25,
                    ground.position.z
                );

                const wall2 = BABYLON.MeshBuilder.CreateBox(
                    "wall2",
                    {
                        width: boxWidth + 0.5,
                        height: wallHeight,
                        depth: wallThickness,
                    },
                    scene
                );

                wall2.position = new BABYLON.Vector3(
                    -0.25,
                    2.25,
                    ground.position.z + boxDepth / 2 + wallThickness / 2
                );
                scene.debugLayer.show();
                return scene;
            };

            window.initFunction = async function () {
                const asyncEngineCreation = async function () {
                    try {
                        return createDefaultEngine();
                    } catch (e) {
                        console.log(
                            "the available createEngine function failed. Creating the default engine instead"
                        );
                        return createDefaultEngine();
                    }
                };

                window.engine = await asyncEngineCreation();
                if (!engine) throw "engine should not be null.";
                startRenderLoop(engine, canvas);
                window.scene = createScene();
            };
            initFunction().then(() => {
                sceneToRender = scene;
            });

            // Resize
            window.addEventListener("resize", function () {
                engine.resize();
            });
        </script>
    </body>
</html>
